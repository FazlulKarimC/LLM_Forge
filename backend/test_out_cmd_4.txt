============================= test session starts =============================
platform win32 -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend
configfile: pytest.ini
plugins: anyio-4.12.0
collected 135 items

tests\test_agent.py .....................................                [ 27%]
tests\test_api.py .....F                                                 [ 31%]
tests\test_metrics.py ...................                                [ 45%]
tests\test_openai_engine.py .....                                        [ 49%]
tests\test_optimization.py ................                              [ 61%]
tests\test_prompting.py .........................                        [ 80%]
tests\test_rag.py ................                                       [ 91%]
tests\test_statistical.py ...........                                    [100%]

================================== FAILURES ===================================
___ TestExperimentRunCustomHeaders.test_run_experiment_with_custom_headers ____

self = <tests.test_api.TestExperimentRunCustomHeaders object at 0x0000025D9783E720>
mock_enqueue = <MagicMock name='_enqueue_or_fallback' id='2601039009968'>
mock_update = <AsyncMock name='update_status' id='2601039494656'>
mock_get = <AsyncMock name='get' id='2601043070224'>
client = <starlette.testclient.TestClient object at 0x0000025D9A018920>

    @patch('app.api.experiments.ExperimentService.get')
    @patch('app.api.experiments.ExperimentService.update_status')
    @patch('app.api.experiments._enqueue_or_fallback')
    def test_run_experiment_with_custom_headers(self, mock_enqueue, mock_update, mock_get, client):
        """Test /run endpoint parses the custom headers correctly."""
        class MockHyperParams:
            temperature = 0.1
            max_tokens = 10
            top_p = 0.9
            top_k = None
            seed = None
    
        class MockConfig:
            model_name = "custom_hosted"
            reasoning_method = "naive"
            dataset_name = "sample"
            num_samples = 2
            rag = None
            agent = None
            optimization = None
            hyperparameters = MockHyperParams()
    
        class MockExperiment:
            id = "00000000-0000-0000-0000-000000000000"
            name = "Test"
            description = ""
            status = "created"  # Will be changed to queued but endpoint returns updated status usually, however mock_get returns this.
            error_message = None
            created_at = "2025-01-01T00:00:00Z"
            updated_at = "2025-01-01T00:00:00Z"
            config = MockConfig()
    
        mock_exp = MockExperiment()
    
        # When run_experiment calls service.get() it returns our mock
        mock_get.return_value = mock_exp
    
        # 2. Run the experiment with headers
        headers = {
            "X-Custom-LLM-Base": "http://mock-base.local/v1",
            "X-Custom-LLM-Key": "mock-api-key"
        }
    
>       run_resp = client.post(
            f"{settings.API_V1_PREFIX}/experiments/{mock_exp.id}/run",
            headers=headers
        )

tests\test_api.py:136: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
venv\Lib\site-packages\starlette\testclient.py:546: in post
    return super().post(
venv\Lib\site-packages\httpx\_client.py:1144: in post
    return self.request(
venv\Lib\site-packages\starlette\testclient.py:445: in request
    return super().request(
venv\Lib\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
venv\Lib\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv\Lib\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\starlette\testclient.py:348: in handle_request
    raise exc
venv\Lib\site-packages\starlette\testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
venv\Lib\site-packages\anyio\from_thread.py:326: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Python312\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Python312\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
venv\Lib\site-packages\anyio\from_thread.py:257: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\fastapi\applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
venv\Lib\site-packages\starlette\applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
venv\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
venv\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv\Lib\site-packages\starlette\middleware\base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Python312\Lib\contextlib.py:158: in __exit__
    self.gen.throw(value)
venv\Lib\site-packages\starlette\_utils.py:85: in collapse_excgroups
    raise exc
venv\Lib\site-packages\starlette\middleware\base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app\core\middleware.py:19: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\starlette\middleware\base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv\Lib\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
venv\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
venv\Lib\site-packages\fastapi\routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv\Lib\site-packages\fastapi\routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
venv\Lib\site-packages\fastapi\routing.py:377: in app
    content = await serialize_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    async def serialize_response(
        *,
        field: Optional[ModelField] = None,
        response_content: Any,
        include: Optional[IncEx] = None,
        exclude: Optional[IncEx] = None,
        by_alias: bool = True,
        exclude_unset: bool = False,
        exclude_defaults: bool = False,
        exclude_none: bool = False,
        is_coroutine: bool = True,
        endpoint_ctx: Optional[EndpointContext] = None,
    ) -> Any:
        if field:
            errors = []
            if is_coroutine:
                value, errors_ = field.validate(response_content, {}, loc=("response",))
            else:
                value, errors_ = await run_in_threadpool(
                    field.validate, response_content, {}, loc=("response",)
                )
            if isinstance(errors_, list):
                errors.extend(errors_)
            if errors:
                ctx = endpoint_ctx or EndpointContext()
>               raise ResponseValidationError(
                    errors=errors,
                    body=response_content,
                    endpoint_ctx=ctx,
                )
E               fastapi.exceptions.ResponseValidationError: 4 validation errors:
E                 {'type': 'int_type', 'loc': ('response', 'config', 'hyperparameters', 'seed'), 'msg': 'Input should be a valid integer', 'input': None}
E                 {'type': 'enum', 'loc': ('response', 'status'), 'msg': "Input should be 'pending', 'queued', 'running', 'completed' or 'failed'", 'input': 'created', 'ctx': {'expected': "'pending', 'queued', 'running', 'completed' or 'failed'"}}
E                 {'type': 'missing', 'loc': ('response', 'started_at'), 'msg': 'Field required', 'input': <tests.test_api.TestExperimentRunCustomHeaders.test_run_experiment_with_custom_headers.<locals>.MockExperiment object at 0x0000025D9A050710>}
E                 {'type': 'missing', 'loc': ('response', 'completed_at'), 'msg': 'Field required', 'input': <tests.test_api.TestExperimentRunCustomHeaders.test_run_experiment_with_custom_headers.<locals>.MockExperiment object at 0x0000025D9A050710>}
E               
E                 File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\app\api\experiments.py", line 175, in run_experiment
E                   POST /api/v1/experiments/{experiment_id}/run

venv\Lib\site-packages\fastapi\routing.py:215: ResponseValidationError
------------------------------ Captured log call ------------------------------
ERROR    app.core.exception_handlers:exception_handlers.py:85 Unhandled Exception on POST http://testserver/api/v1/experiments/00000000-0000-0000-0000-000000000000/run [RequestID: 1374d36c-7714-40fb-b519-792f0f3750b7]
Traceback (most recent call last):
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\middleware\base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Python312\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\_utils.py", line 85, in collapse_excgroups
    raise exc
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\middleware\base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\app\core\middleware.py", line 19, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\middleware\base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\fastapi\routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\fastapi\routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\fastapi\routing.py", line 377, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\venv\Lib\site-packages\fastapi\routing.py", line 215, in serialize_response
    raise ResponseValidationError(
fastapi.exceptions.ResponseValidationError: 4 validation errors:
  {'type': 'int_type', 'loc': ('response', 'config', 'hyperparameters', 'seed'), 'msg': 'Input should be a valid integer', 'input': None}
  {'type': 'enum', 'loc': ('response', 'status'), 'msg': "Input should be 'pending', 'queued', 'running', 'completed' or 'failed'", 'input': 'created', 'ctx': {'expected': "'pending', 'queued', 'running', 'completed' or 'failed'"}}
  {'type': 'missing', 'loc': ('response', 'started_at'), 'msg': 'Field required', 'input': <tests.test_api.TestExperimentRunCustomHeaders.test_run_experiment_with_custom_headers.<locals>.MockExperiment object at 0x0000025D9A050710>}
  {'type': 'missing', 'loc': ('response', 'completed_at'), 'msg': 'Field required', 'input': <tests.test_api.TestExperimentRunCustomHeaders.test_run_experiment_with_custom_headers.<locals>.MockExperiment object at 0x0000025D9A050710>}

  File "C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\app\api\experiments.py", line 175, in run_experiment
    POST /api/v1/experiments/{experiment_id}/run
============================== warnings summary ===============================
app\schemas\result.py:47
  C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\app\schemas\result.py:47: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RunSummary(BaseModel):

app\schemas\result.py:71
  C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\app\schemas\result.py:71: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ResultResponse(BaseModel):

app\schemas\run.py:37
  C:\Users\FAZLUL\Desktop\MainProject\LlmForge\backend\app\schemas\run.py:37: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RunResponse(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_api.py::TestExperimentRunCustomHeaders::test_run_experiment_with_custom_headers
================== 1 failed, 134 passed, 3 warnings in 9.93s ==================
